var MCP=function(e){var t={};function s(n){if(t[n]){return t[n].exports}var i=t[n]={i:n,l:false,exports:{}};e[n].call(i.exports,i,i.exports,s);i.l=true;return i.exports}s.m=e;s.c=t;s.d=function(e,t,n){if(!s.o(e,t)){Object.defineProperty(e,t,{enumerable:true,get:n})}};s.r=function(e){if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})};s.t=function(e,t){if(t&1)e=s(e);if(t&8)return e;if(t&4&&typeof e==="object"&&e&&e.__esModule)return e;var n=Object.create(null);s.r(n);Object.defineProperty(n,"default",{enumerable:true,value:e});if(t&2&&typeof e!="string")for(var i in e)s.d(n,i,function(t){return e[t]}.bind(null,i));return n};s.n=function(e){var t=e&&e.__esModule?function t(){return e["default"]}:function t(){return e};s.d(t,"a",t);return t};s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)};s.p="/dist/";return s(s.s=217)}({10:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:true});class n{constructor(){this.foods=[];this.snakes=[];this.gaussR=8;this.gauss=[];this.globZoom=1.5;this.automaticZoom=true;this.state=1;this.frameCount=0;this.lastTime=0;this.panX=0;this.panY=0;this.targetX=0;this.targetY=0;this.names=["Fred","Nicolas","Yacine","Olivia","Medhi","Christian","Laura","Guillaume","Sandrine","Lila","Sarah","Cecile","Philippe","Emmy","Florian"];this.init();for(let e=0;e<1e4;e++){}}init(){}}n.BORDER_SIZE=200;n.NBINITIALSNAKES=14;n.NBINITIALFOODS=1e4;n.IMG_SIZE=128;n.LOOSEWEIGHT=2;n.LOOSEWEIGHTPACE=4;n.WORLDRADIUS=1500;n.MIN_SPEED=4;n.PREF_SPEED=4;n.MAX_SPEED=8;n.SPACEBETWEENSEGMENTS=10;n.MAX_TURN=Math.PI/48;n.colors=[[[0,0,255],[0,0,255],[255,255,255],[255,255,255],[255,0,0],[255,0,0]],[[96,96,255],[96,96,192],[96,96,128],[96,96,96],[96,96,128],[96,96,192]],[[255,96,0],[192,96,0],[128,96,0],[96,96,0],[128,96,0],[192,96,0]],[[0,0,255],[0,255,255],[0,255,0],[255,255,0],[255,0,0],[255,0,255]],[[0,255,0],[0,255,0],[255,0,0],[255,0,0],[255,0,0],[255,0,0]],[[0,0,0],[0,0,0],[255,0,0],[255,0,0],[255,255,0],[255,255,0]],[[255,0,0],[255,0,0],[255,0,0],[255,255,0],[255,255,0],[255,255,0]],[[255,0,0],[255,255,0],[255,0,0],[255,255,0],[255,0,0],[255,255,0]],[[255,0,0],[255,0,0],[255,255,255],[255,255,255],[0,0,255],[0,0,255]],[[255,0,0],[255,0,0],[255,255,255],[255,255,255],[255,0,255],[255,0,0]],[[0,192,0],[0,192,0],[255,255,255],[255,255,255],[255,128,0],[255,128,0]],[[0,0,0],[0,0,0],[255,255,0],[255,255,0],[255,0,0],[255,0,0]],[[255,255,255],[255,255,255],[255,255,255],[255,255,255],[255,255,255],[255,255,255]],[[0,255,0],[0,255,0],[255,255,255],[255,255,255],[255,0,0],[255,0,0]]];n.teamNames=["France","Blues","Reds","Rainbow","Portugal","Germany","Spain","Castilla","Nederland","Austria","Ireland","Belgium","White knights","Italie"];t.SaclaySlitherGame=n},100:function(e,t){function s(e){var t=new Error("Cannot find module '"+e+"'");t.code="MODULE_NOT_FOUND";throw t}s.keys=function(){return[]};s.resolve=s;e.exports=s;s.id=100},101:function(e,t,s){(function(n){var i=s(208),r=s(6),o=r.join,a=r.dirname,l=i.accessSync&&function(e){try{i.accessSync(e)}catch(e){return false}return true}||i.existsSync||r.existsSync,h={arrow:process.env.NODE_BINDINGS_ARROW||" → ",compiled:process.env.NODE_BINDINGS_COMPILED_DIR||"compiled",platform:process.platform,arch:process.arch,version:process.versions.node,bindings:"bindings.node",try:[["module_root","build","bindings"],["module_root","build","Debug","bindings"],["module_root","build","Release","bindings"],["module_root","out","Debug","bindings"],["module_root","Debug","bindings"],["module_root","out","Release","bindings"],["module_root","Release","bindings"],["module_root","build","default","bindings"],["module_root","compiled","version","platform","arch","bindings"]]};function c(e){if(typeof e=="string"){e={bindings:e}}else if(!e){e={}}Object.keys(h).map(function(t){if(!(t in e))e[t]=h[t]});if(!e.module_root){e.module_root=t.getRoot(t.getFileName())}if(r.extname(e.bindings)!=".node"){e.bindings+=".node"}var n=[],i=0,a=e.try.length,l,c,f;for(;i<a;i++){l=o.apply(null,e.try[i].map(function(t){return e[t]||t}));n.push(l);try{c=e.path?s(100).resolve(l):s(100)(l);if(!e.path){c.path=l}return c}catch(e){if(!/not find/i.test(e.message)){throw e}}}f=new Error("Could not locate the bindings file. Tried:\n"+n.map(function(t){return e.arrow+t}).join("\n"));f.tries=n;throw f}e.exports=t=c;t.getFileName=function e(t){var s=Error.prepareStackTrace,i=Error.stackTraceLimit,r={},o;Error.stackTraceLimit=10;Error.prepareStackTrace=function(e,s){for(var i=0,r=s.length;i<r;i++){o=s[i].getFileName();if(o!==n){if(t){if(o!==t){return}}else{return}}}};Error.captureStackTrace(r);r.stack;Error.prepareStackTrace=s;Error.stackTraceLimit=i;return o};t.getRoot=function e(t){var s=a(t),n;while(true){if(s==="."){s=process.cwd()}if(l(o(s,"package.json"))||l(o(s,"node_modules"))){return s}if(n===s){throw new Error('Could not find module root given file: "'+t+'". Do you have a `package.json` file? ')}n=s;s=o(s,"..")}}}).call(this,"/index.js")},102:function(e,t){e.exports=require("http")},103:function(e,t){e.exports=require("events")},104:function(e,t,s){"use strict";const n=s(103);const i=s(43);const r=s(214);const o=s(102);const a=s(213);const l=s(212);const h=s(18);const c=s(24);const f=s(206);const d=s(99);const u=s(17);const p=s(98);const m=s(96);const S=["CONNECTING","OPEN","CLOSING","CLOSED"];const _=u.kWebSocket;const y=[8,13];const g=30*1e3;class k extends n{constructor(e,t,s){super();this.readyState=k.CONNECTING;this.protocol="";this._binaryType=u.BINARY_TYPES[0];this._closeFrameReceived=false;this._closeFrameSent=false;this._closeMessage="";this._closeTimer=null;this._closeCode=1006;this._extensions={};this._isServer=true;this._receiver=null;this._sender=null;this._socket=null;if(e!==null){if(Array.isArray(t)){t=t.join(", ")}else if(typeof t==="object"&&t!==null){s=t;t=undefined}x.call(this,e,t,s)}}get CONNECTING(){return k.CONNECTING}get CLOSING(){return k.CLOSING}get CLOSED(){return k.CLOSED}get OPEN(){return k.OPEN}get binaryType(){return this._binaryType}set binaryType(e){if(u.BINARY_TYPES.indexOf(e)<0)return;this._binaryType=e;if(this._receiver)this._receiver._binaryType=e}get bufferedAmount(){if(!this._socket)return 0;return(this._socket.bufferSize||0)+this._sender._bufferedBytes}get extensions(){return Object.keys(this._extensions).join()}setSocket(e,t,s){const n=new p(this._binaryType,this._extensions,s);this._sender=new m(e,this._extensions);this._receiver=n;this._socket=e;n[_]=this;e[_]=this;n.on("conclude",b);n.on("drain",O);n.on("error",M);n.on("message",I);n.on("ping",T);n.on("pong",L);e.setTimeout(0);e.setNoDelay();if(t.length>0)e.unshift(t);e.on("close",D);e.on("data",F);e.on("end",P);e.on("error",B);this.readyState=k.OPEN;this.emit("open")}emitClose(){this.readyState=k.CLOSED;if(!this._socket){this.emit("close",this._closeCode,this._closeMessage);return}if(this._extensions[c.extensionName]){this._extensions[c.extensionName].cleanup()}this._receiver.removeAllListeners();this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState===k.CLOSED)return;if(this.readyState===k.CONNECTING){const e="WebSocket was closed before the connection was established";return E(this,this._req,e)}if(this.readyState===k.CLOSING){if(this._closeFrameSent&&this._closeFrameReceived)this._socket.end();return}this.readyState=k.CLOSING;this._sender.close(e,t,!this._isServer,e=>{if(e)return;this._closeFrameSent=true;if(this._socket.writable){if(this._closeFrameReceived)this._socket.end();this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),g)}})}ping(e,t,s){if(typeof e==="function"){s=e;e=t=undefined}else if(typeof t==="function"){s=t;t=undefined}if(this.readyState!==k.OPEN){const e=new Error(`WebSocket is not open: readyState ${this.readyState} `+`(${S[this.readyState]})`);if(s)return s(e);throw e}if(typeof e==="number")e=e.toString();if(t===undefined)t=!this._isServer;this._sender.ping(e||u.EMPTY_BUFFER,t,s)}pong(e,t,s){if(typeof e==="function"){s=e;e=t=undefined}else if(typeof t==="function"){s=t;t=undefined}if(this.readyState!==k.OPEN){const e=new Error(`WebSocket is not open: readyState ${this.readyState} `+`(${S[this.readyState]})`);if(s)return s(e);throw e}if(typeof e==="number")e=e.toString();if(t===undefined)t=!this._isServer;this._sender.pong(e||u.EMPTY_BUFFER,t,s)}send(e,t,s){if(typeof t==="function"){s=t;t={}}if(this.readyState!==k.OPEN){const e=new Error(`WebSocket is not open: readyState ${this.readyState} `+`(${S[this.readyState]})`);if(s)return s(e);throw e}if(typeof e==="number")e=e.toString();const n=Object.assign({binary:typeof e!=="string",mask:!this._isServer,compress:true,fin:true},t);if(!this._extensions[c.extensionName]){n.compress=false}this._sender.send(e||u.EMPTY_BUFFER,n,s)}terminate(){if(this.readyState===k.CLOSED)return;if(this.readyState===k.CONNECTING){const e="WebSocket was closed before the connection was established";return E(this,this._req,e)}if(this._socket){this.readyState=k.CLOSING;this._socket.destroy()}}}S.forEach((e,t)=>{k[S[t]]=t});["open","error","close","message"].forEach(e=>{Object.defineProperty(k.prototype,`on${e}`,{get(){const t=this.listeners(e);for(var s=0;s<t.length;s++){if(t[s]._listener)return t[s]._listener}},set(t){const s=this.listeners(e);for(var n=0;n<s.length;n++){if(s[n]._listener)this.removeListener(e,s[n])}this.addEventListener(e,t)}})});k.prototype.addEventListener=f.addEventListener;k.prototype.removeEventListener=f.removeEventListener;e.exports=k;function x(e,t,s){s=Object.assign({protocolVersion:y[1],perMessageDeflate:true},s,{createConnection:undefined,socketPath:undefined,hostname:undefined,protocol:undefined,timeout:undefined,method:undefined,auth:undefined,host:undefined,path:undefined,port:undefined});if(y.indexOf(s.protocolVersion)===-1){throw new RangeError(`Unsupported protocol version: ${s.protocolVersion} `+`(supported versions: ${y.join(", ")})`)}this._isServer=false;var n;if(typeof e==="object"&&e.href!==undefined){n=e;this.url=e.href}else{n=h.parse(e);this.url=e}const a=n.protocol==="ws+unix:";if(!n.host&&(!a||!n.pathname)){throw new Error(`Invalid URL: ${this.url}`)}const l=n.protocol==="wss:"||n.protocol==="https:";const f=i.randomBytes(16).toString("base64");const p=l?r:o;const m=n.search?`${n.pathname||"/"}${n.search}`:n.pathname||"/";var S;s.createConnection=l?w:v;s.port=n.port||(l?443:80);s.host=n.hostname.startsWith("[")?n.hostname.slice(1,-1):n.hostname;s.headers=Object.assign({"Sec-WebSocket-Version":s.protocolVersion,"Sec-WebSocket-Key":f,Connection:"Upgrade",Upgrade:"websocket"},s.headers);s.path=m;if(s.perMessageDeflate){S=new c(s.perMessageDeflate!==true?s.perMessageDeflate:{},false);s.headers["Sec-WebSocket-Extensions"]=d.format({[c.extensionName]:S.offer()})}if(t){s.headers["Sec-WebSocket-Protocol"]=t}if(s.origin){if(s.protocolVersion<13){s.headers["Sec-WebSocket-Origin"]=s.origin}else{s.headers.Origin=s.origin}}if(n.auth){s.auth=n.auth}else if(n.username||n.password){s.auth=`${n.username}:${n.password}`}if(a){const e=m.split(":");if(s.agent==null&&process.versions.modules<57){s._socketPath=e[0]}else{s.socketPath=e[0]}s.path=e[1]}var _=this._req=p.get(s);if(s.handshakeTimeout){_.setTimeout(s.handshakeTimeout,()=>E(this,_,"Opening handshake has timed out"))}_.on("error",e=>{if(this._req.aborted)return;_=this._req=null;this.readyState=k.CLOSING;this.emit("error",e);this.emitClose()});_.on("response",e=>{if(this.emit("unexpected-response",_,e))return;E(this,_,`Unexpected server response: ${e.statusCode}`)});_.on("upgrade",(e,s,n)=>{this.emit("upgrade",e);if(this.readyState!==k.CONNECTING)return;_=this._req=null;const r=i.createHash("sha1").update(f+u.GUID,"binary").digest("base64");if(e.headers["sec-websocket-accept"]!==r){E(this,s,"Invalid Sec-WebSocket-Accept header");return}const o=e.headers["sec-websocket-protocol"];const a=(t||"").split(/, */);var l;if(!t&&o){l="Server sent a subprotocol but none was requested"}else if(t&&!o){l="Server sent no subprotocol"}else if(o&&a.indexOf(o)===-1){l="Server sent an invalid subprotocol"}if(l){E(this,s,l);return}if(o)this.protocol=o;if(S){try{const t=d.parse(e.headers["sec-websocket-extensions"]);if(t[c.extensionName]){S.accept(t[c.extensionName]);this._extensions[c.extensionName]=S}}catch(e){E(this,s,"Invalid Sec-WebSocket-Extensions header");return}}this.setSocket(s,n,0)})}function v(e){e.path=e.socketPath||e._socketPath||undefined;return a.connect(e)}function w(e){e.path=e.socketPath||e._socketPath||undefined;e.servername=e.servername||e.host;return l.connect(e)}function E(e,t,s){e.readyState=k.CLOSING;const n=new Error(s);Error.captureStackTrace(n,E);if(t.setHeader){t.abort();t.once("abort",e.emitClose.bind(e));e.emit("error",n)}else{t.destroy(n);t.once("error",e.emit.bind(e,"error"));t.once("close",e.emitClose.bind(e))}}function b(e,t){const s=this[_];s._socket.removeListener("data",F);s._socket.resume();s._closeFrameReceived=true;s._closeMessage=t;s._closeCode=e;if(e===1005)s.close();else s.close(e,t)}function O(){this[_]._socket.resume()}function M(e){const t=this[_];t.readyState=k.CLOSING;t._closeCode=e[u.kStatusCode];t.emit("error",e);t._socket.destroy()}function N(){this[_].emitClose()}function I(e){this[_].emit("message",e)}function T(e){const t=this[_];t.pong(e,!t._isServer,u.NOOP);t.emit("ping",e)}function L(e){this[_].emit("pong",e)}function D(){const e=this[_];this.removeListener("close",D);this.removeListener("data",F);this.removeListener("end",P);this[_]=undefined;e.readyState=k.CLOSING;e._socket.read();e._receiver.end();clearTimeout(e._closeTimer);if(e._receiver._writableState.finished||e._receiver._writableState.errorEmitted){e.emitClose()}else{e._receiver.on("error",N);e._receiver.on("finish",N)}}function F(e){if(!this[_]._receiver.write(e)){this.pause()}}function P(){const e=this[_];e.readyState=k.CLOSING;e._receiver.end();this.end()}function B(){const e=this[_];this.removeListener("error",B);this.on("error",u.NOOP);if(e){e.readyState=k.CLOSING;this.destroy()}}},17:function(e,t,s){"use strict";e.exports={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),EMPTY_BUFFER:Buffer.alloc(0),NOOP:()=>{}}},18:function(e,t){e.exports=require("url")},19:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:true});const n=s(10);const i=s(25);function r(e,t){return e+Math.floor(Math.random()*Math.floor(t-e))}class o{constructor(e,t){this.x=e;this.y=t;this.rd=10}}t.Point=o;class a extends o{constructor(e,t,s){super(e,t);this.type=s}static newFood(e){let t=r(0,1e4)*Math.PI/5e3;let s=r(0,n.SaclaySlitherGame.WORLDRADIUS/20);let i=r(0,n.SaclaySlitherGame.colors.length);let o=r(0,n.SaclaySlitherGame.colors[0].length);let l=new a(n.SaclaySlitherGame.WORLDRADIUS/2+s*Math.cos(t),n.SaclaySlitherGame.WORLDRADIUS/2+s*Math.sin(t),i*n.SaclaySlitherGame.colors[0].length+o);return l}}t.Food=a;var l;(function(e){e[e["FREE"]=-1]="FREE";e[e["RANDWALK"]=0]="RANDWALK";e[e["ROT"]=1]="ROT";e[e["FASTSTRAIGHT"]=2]="FASTSTRAIGHT";e[e["AVOIDCLOSEST"]=3]="AVOIDCLOSEST";e[e["GOCLOSESTFOOD"]=4]="GOCLOSESTFOOD";e[e["GOBESTFOOD"]=5]="GOBESTFOOD";e[e["AVOIDWORST"]=6]="AVOIDWORST";e[e["AVOIDBORDER"]=7]="AVOIDBORDER"})(l=t.SnakeStrategy||(t.SnakeStrategy={}));class h{constructor(e,t,s,i,r,a,h,c,f){this.pos=[];this.size=0;this.weight=0;this.dirX=1;this.dirY=0;this.speed=0;this.dAlph=0;this.state=l.GOBESTFOOD;this.bestFood=null;this.dbestFood=0;this.closestFood=null;this.dclosestFood=0;this.closestSnake=null;this.closestSnakeP=null;this.dclosestSnake=0;this.closestBadSnake=null;this.closestBadSnakeP=null;this.dclosestBadSnake=0;this.type=a;this.ssg=e;this.speed=n.SaclaySlitherGame.PREF_SPEED;this.state=f;this.name=t;let d=Math.hypot(h,c)/n.SaclaySlitherGame.SPACEBETWEENSEGMENTS;this.dirX=h/d;this.dirY=c/d;this.size=Math.floor(4+Math.sqrt(s)/10+s/25);let u=new o(i,r);this.pos.push(u);for(let e=1;e<this.size;e++){let t=new o(i-e*this.dirX,r-e*this.dirY);this.pos.push(t)}this.setWeight(s)}setWeight(e){this.weight=e;for(let e=this.size-1;e>=0;e--){let t=this.pos[e];t.rd=10+Math.sqrt(this.weight-39)/4;if(e==1)t.rd-=2;if(e==2)t.rd--}let t=8;for(let e=this.size-1;e>=3;e--){let s=this.pos[e];if(t<s.rd)s.rd=t;else break;t+=1}}translate(e,t,s,n){let i=e-this.pos[0].x;let r=t-this.pos[0].y;let o=s-this.pos[this.pos.length-1].x;let a=n-this.pos[this.pos.length-1].y;for(let e=0;e<this.pos.length;e++){this.pos[e].x+=(i*(this.pos.length-1-e)+o*e)/(this.pos.length-1);this.pos[e].y+=(r*(this.pos.length-1-e)+a*e)/(this.pos.length-1)}}setLocations(e){for(let t=0;t<this.pos.length;t++){this.pos[t].x=e[t*2+0];this.pos[t].y=e[t*2+1]}}moveSnake(e,t){let s=this.pos[0];let r=this.pos[this.pos.length-1];let o=.75+64/(128+this.size);let l=i.dist(s.x,s.y,e,t);let h=Math.atan2(t-s.y,e-s.x);let c=Math.atan2(this.dirY,this.dirX);let f=h-c;if(f>Math.PI)f-=2*Math.PI;if(f<-Math.PI)f+=2*Math.PI;if(f>n.SaclaySlitherGame.MAX_TURN*o*o*o){e=s.x+Math.max(l,n.SaclaySlitherGame.MIN_SPEED)*Math.cos(c+n.SaclaySlitherGame.MAX_TURN*o*o*o);t=s.y+Math.max(l,n.SaclaySlitherGame.MIN_SPEED)*Math.sin(c+n.SaclaySlitherGame.MAX_TURN*o*o*o)}else if(f<-n.SaclaySlitherGame.MAX_TURN*o*o*o){e=s.x+Math.max(l,n.SaclaySlitherGame.MIN_SPEED)*Math.cos(c-n.SaclaySlitherGame.MAX_TURN*o*o*o);t=s.y+Math.max(l,n.SaclaySlitherGame.MIN_SPEED)*Math.sin(c-n.SaclaySlitherGame.MAX_TURN*o*o*o)}else{e=Math.round(s.x+Math.max(l,n.SaclaySlitherGame.MIN_SPEED)*Math.cos(h));t=Math.round(s.y+Math.max(l,n.SaclaySlitherGame.MIN_SPEED)*Math.sin(h))}let d=i.dist(s.x,s.y,e,t);let u=e;let p=t;if(d>this.speed){u=s.x+(e-s.x)/d*this.speed;p=s.y+(t-s.y)/d*this.speed}if(d>0){this.dirX=(e-s.x)/d*this.speed;this.dirY=(t-s.y)/d*this.speed}if(this.speed>n.SaclaySlitherGame.PREF_SPEED&&this.ssg.frameCount%n.SaclaySlitherGame.LOOSEWEIGHTPACE==0){this.setWeight(this.weight-n.SaclaySlitherGame.LOOSEWEIGHT);let e=new a(r.x,r.y,this.type);e.rd=1;this.ssg.foods.push(e);if(4+Math.sqrt(this.weight)/10+this.weight/25<this.size){this.size--;this.pos.splice(this.pos.length-1,1)}if(this.weight<40+n.SaclaySlitherGame.LOOSEWEIGHT){this.speed=n.SaclaySlitherGame.PREF_SPEED}}let m=0;let S=this.dAlph;for(let e=0;e<this.pos.length;e++){S+=.25;let t=this.pos[e];let s=i.dist(t.x,t.y,u,p);let r=Math.atan2(p-t.y,u-t.x);f=r-c;if(f>Math.PI)f-=2*Math.PI;if(f<-Math.PI)f+=2*Math.PI;if(f>n.SaclaySlitherGame.MAX_TURN){f=n.SaclaySlitherGame.MAX_TURN}else if(f<-n.SaclaySlitherGame.MAX_TURN){f=-n.SaclaySlitherGame.MAX_TURN}if(s>m){t.x=u-m*Math.cos(c+f)+Math.sin(S*2)/12*m*Math.sin(c+f);t.y=p-m*Math.sin(c+f)-Math.sin(S*2)/12*m*Math.cos(c+f)}u=t.x;p=t.y;c=r;m=n.SaclaySlitherGame.SPACEBETWEENSEGMENTS+2*Math.sin(S)}this.dAlph+=.02*this.speed}testCollision(e){let t=this.pos[0];let s=this.pos[this.pos.length-1];this.closestSnake=null;this.closestSnakeP=null;this.closestBadSnake=null;this.closestBadSnakeP=null;this.dclosestBadSnake=n.SaclaySlitherGame.WORLDRADIUS;this.dclosestSnake=n.SaclaySlitherGame.WORLDRADIUS;if(i.dist(0,0,t.x,t.y)>n.SaclaySlitherGame.WORLDRADIUS){return true}for(let e=0;e<this.ssg.snakes.length;e++){let s=this.ssg.snakes[e];if(s!=null&&s!=this){for(let e=0;e<s.pos.length;e++){let n=s.pos[e];let r=i.dist(n.x,n.y,t.x,t.y);if(r<t.rd+n.rd){return true}else{if(this.closestSnake==null||r<this.dclosestSnake){this.closestSnake=s;this.closestSnakeP=n;this.dclosestSnake=r}let e=Math.atan2(this.dirY,this.dirX);let i=Math.atan2(n.y-t.y,n.x-t.x);let o=Math.abs(e-i);if(this.closestBadSnake==null||r*Math.sin(o/2+1)<this.dclosestBadSnake){this.closestBadSnake=s;this.closestBadSnakeP=n;this.dclosestBadSnake=r*Math.sin(o/2+1)}}}}}let r=this.speed*Math.sin(Math.PI/2-n.SaclaySlitherGame.MAX_TURN)/Math.sin(Math.PI-2*n.SaclaySlitherGame.MAX_TURN);let a=i.dist(0,0,this.dirX,this.dirY);let l=t.x+this.dirY*r/a;let h=t.y-this.dirX*r/a;let c=t.x-this.dirY*r/a;let f=t.y+this.dirX*r/a;this.closestFood=null;this.bestFood=null;this.dclosestFood=n.SaclaySlitherGame.WORLDRADIUS;for(let n=this.ssg.foods.length-1;n>=0;n--){let a=this.ssg.foods[n];let d=i.dist(t.x,t.y,a.x,a.y);let u=Math.atan2(a.y-t.y,a.x-t.x);let p=i.dist(l,h,a.x,a.y);let m=i.dist(c,f,a.x,a.y);if(d<t.rd+a.rd){this.setWeight(this.weight+Math.round(a.rd));if(4+Math.sqrt(this.weight)/10+this.weight/25>this.size){this.size++;let e=new o(s.x,s.y);e.rd=8;this.pos.push(e)}this.ssg.foods[n].rd=0;e.push(n)}else{if((this.closestFood==null||d<this.dclosestFood)&&(p>r&&m>r)){this.closestFood=a;this.dclosestFood=d}if((this.bestFood==null||d/a.rd<this.dbestFood)&&(p>r&&m>r)){this.bestFood=a;this.dbestFood=d/a.rd}}}return false}}t.Snake=h},201:function(e,t,s){var n,i,r;!function(s,o){true?!(i=[],n=o,r=typeof n==="function"?n.apply(t,i):n,r!==undefined&&(e.exports=r)):undefined}(this,function(){return function(){function e(t){var s,n;if(this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.maxElements=t.maxElements,null==this.width||null==this.height)throw new Error("Missing quadtree dimensions.");if(null==this.x&&(this.x=0),null==this.y&&(this.y=0),null==this.maxElements&&(this.maxElements=1),this.contents=[],this.oversized=[],this.size=0,this.width<1||this.height<1)throw new Error("Dimensions must be positive integers.");if(!Number.isInteger(this.x)||!Number.isInteger(this.y))throw new Error("Coordinates must be integers");if(this.maxElements<1)throw new Error("The maximum number of elements before a split must be a positive integer.");n=this,this.children={NW:{create:function(){return new e({x:n.x,y:n.y,width:Math.max(Math.floor(n.width/2),1),height:Math.max(Math.floor(n.height/2),1),maxElements:n.maxElements})},tree:null},NE:{create:function(){return new e({x:n.x+Math.max(Math.floor(n.width/2),1),y:n.y,width:Math.ceil(n.width/2),height:Math.max(Math.floor(n.height/2),1),maxElements:n.maxElements})},tree:null},SW:{create:function(){return new e({x:n.x,y:n.y+Math.max(Math.floor(n.height/2),1),width:Math.max(Math.floor(n.width/2),1),height:Math.ceil(n.height/2),maxElements:n.maxElements})},tree:null},SE:{create:function(){return new e({x:n.x+Math.max(Math.floor(n.width/2),1),y:n.y+Math.max(Math.floor(n.height/2),1),width:Math.ceil(n.width/2),height:Math.ceil(n.height/2),maxElements:n.maxElements})},tree:null}};for(s in this.children)this.children[s].get=function(){return null!=this.tree?this.tree:(this.tree=this.create(),this.tree)}}var t,s,n,i,r,o,a,l;return i=function(e){var t,s;return{x:Math.floor((null!=(t=e.width)?t:1)/2)+e.x,y:Math.floor((null!=(s=e.height)?s:1)/2)+e.y}},t=function(e,t){var s,n,i,r;return!(e.x>=t.x+(null!=(s=t.width)?s:1)||e.x+(null!=(n=e.width)?n:1)<=t.x||e.y>=t.y+(null!=(i=t.height)?i:1)||e.y+(null!=(r=e.height)?r:1)<=t.y)},s=function(e,t){var s;return s=i(t),e.x<s.x?e.y<s.y?"NW":"SW":e.y<s.y?"NE":"SE"},l=function(e){if("object"!=typeof e)throw new Error("Element must be an Object.");if(null==e.x||null==e.y)throw new Error("Coordinates properties are missing.");if((null!=e?e.width:void 0)<0||(null!=e?e.height:void 0)<0)throw new Error("Width and height must be positive integers.")},o=function(e){var t,s,n,i;return s=Math.max(Math.floor(e.width/2),1),n=Math.ceil(e.width/2),i=Math.max(Math.floor(e.height/2),1),t=Math.ceil(e.height/2),{NW:{x:e.x,y:e.y,width:s,height:i},NE:{x:e.x+s,y:e.y,width:n,height:i},SW:{x:e.x,y:e.y+i,width:s,height:t},SE:{x:e.x+s,y:e.y+i,width:n,height:t}}},n=function(e,s){var n,i,r,a;a=[],r=o(s);for(i in r)n=r[i],t(e,n)&&a.push(i);return a},r=function(e,t){var s;return(s=function(s){return e["_"+s]=e[s],Object.defineProperty(e,s,{set:function(e){return t.remove(this,!0),this["_"+s]=e,t.push(this)},get:function(){return this["_"+s]},configurable:!0})})("x"),s("y"),s("width"),s("height")},a=function(e){var t;return(t=function(t){if(null!=e["_"+t])return delete e[t],e[t]=e["_"+t],delete e["_"+t]})("x"),t("y"),t("width"),t("height")},e.prototype.clear=function(){var e,t;this.contents=[],this.oversized=[],this.size=0,t=[];for(e in this.children)t.push(this.children[e].tree=null);return t},e.prototype.push=function(e,t){return this.pushAll([e],t)},e.prototype.pushAll=function(e,t){var s,i,o,a,h,c,f,d,u,p,m,S,_,y,g,k,x,v,w,E;for(m=0,y=e.length;m<y;m++)p=e[m],l(p),t&&r(p,this);for(f=[{tree:this,elements:e}];f.length>0;){for(E=(x=f.shift()).tree,d={NW:null,NE:null,SW:null,SE:null},S=0,g=(c=x.elements).length;S<g;S++)if(h=c[S],E.size++,1!==(u=n(h,E)).length||1===E.width||1===E.height)E.oversized.push(h);else if(E.size-E.oversized.length<=E.maxElements)E.contents.push(h);else{for(a=u[0],w=E.children[a],null==d[a]&&(d[a]={tree:w.get(),elements:[]}),d[a].elements.push(h),_=0,k=(v=E.contents).length;_<k;_++)i=v[_],null==d[o=n(i,E)[0]]&&(d[o]={tree:E.children[o].get(),elements:[]}),d[o].elements.push(i);E.contents=[]}for(a in d)null!=(s=d[a])&&f.push(s)}return this},e.prototype.remove=function(e,t){var n,i;return l(e),(n=this.oversized.indexOf(e))>-1?(this.oversized.splice(n,1),this.size--,t||a(e),!0):(n=this.contents.indexOf(e))>-1?(this.contents.splice(n,1),this.size--,t||a(e),!0):!(null==(i=this.children[s(e,this)]).tree||!i.tree.remove(e,t)||(this.size--,0===i.tree.size&&(i.tree=null),0))},e.prototype.colliding=function(e,s){var i,r,o,a,h,c,f,d,u,p,m,S,_,y;for(null==s&&(s=t),l(e),h=[],o=[this];o.length>0;){for(c=0,u=(S=(y=o.shift()).oversized).length;c<u;c++)(r=S[c])!==e&&s(e,r)&&h.push(r);for(f=0,p=(_=y.contents).length;f<p;f++)(r=_[f])!==e&&s(e,r)&&h.push(r);for(0===(a=n(e,y)).length&&(a=[],e.x>=y.x+y.width&&a.push("NE"),e.y>=y.y+y.height&&a.push("SW"),a.length>0&&(1===a.length?a.push("SE"):a=["SE"])),d=0,m=a.length;d<m;d++)i=a[d],null!=y.children[i].tree&&o.push(y.children[i].tree)}return h},e.prototype.onCollision=function(e,s,i){var r,o,a,h,c,f,d,u,p,m,S,_,y;for(null==i&&(i=t),l(e),a=[this];a.length>0;){for(c=0,u=(S=(y=a.shift()).oversized).length;c<u;c++)(o=S[c])!==e&&i(e,o)&&s(o);for(f=0,p=(_=y.contents).length;f<p;f++)(o=_[f])!==e&&i(e,o)&&s(o);for(0===(h=n(e,y)).length&&(h=[],e.x>=y.x+y.width&&h.push("NE"),e.y>=y.y+y.height&&h.push("SW"),h.length>0&&(1===h.length?h.push("SE"):h=["SE"])),d=0,m=h.length;d<m;d++)r=h[d],null!=y.children[r].tree&&a.push(y.children[r].tree)}return null},e.prototype.get=function(e){return this.where(e)},e.prototype.where=function(e){var t,n,i,r,o,a,h,c,f,d,u,p,m;if("object"==typeof e&&(null==e.x||null==e.y))return this.find(function(t){var s,n;s=!0;for(n in e)e[n]!==t[n]&&(s=!1);return s});for(l(e),r=[],i=[this];i.length>0;){for(o=0,c=(d=(m=i.shift()).oversized).length;o<c;o++){n=d[o],t=!0;for(h in e)e[h]!==n[h]&&(t=!1);t&&r.push(n)}for(a=0,f=(u=m.contents).length;a<f;a++){n=u[a],t=!0;for(h in e)e[h]!==n[h]&&(t=!1);t&&r.push(n)}null!=(p=m.children[s(e,m)]).tree&&i.push(p.tree)}return r},e.prototype.each=function(e){var t,s,n,i,r,o,a,l,h,c;for(s=[this];s.length>0;){for(i=0,o=(l=(c=s.shift()).oversized).length;i<o;i++)n=l[i],"function"==typeof e&&e(n);for(r=0,a=(h=c.contents).length;r<a;r++)n=h[r],"function"==typeof e&&e(n);for(t in c.children)null!=c.children[t].tree&&s.push(c.children[t].tree)}return this},e.prototype.find=function(e){var t,s,n,i,r,o,a,l,h,c,f;for(s=[this],i=[];s.length>0;){for(r=0,a=(h=(f=s.shift()).oversized).length;r<a;r++)n=h[r],("function"==typeof e?e(n):void 0)&&i.push(n);for(o=0,l=(c=f.contents).length;o<l;o++)n=c[o],("function"==typeof e?e(n):void 0)&&i.push(n);for(t in f.children)null!=f.children[t].tree&&s.push(f.children[t].tree)}return i},e.prototype.filter=function(t){var s;return(s=function(n){var i,r,o,a,l,h,c,f,d,u,p;(r=new e({x:n.x,y:n.y,width:n.width,height:n.height,maxElements:n.maxElements})).size=0;for(i in n.children)null!=n.children[i].tree&&(r.children[i].tree=s(n.children[i].tree),r.size+=null!=(f=null!=(d=r.children[i].tree)?d.size:void 0)?f:0);for(a=0,h=(u=n.oversized).length;a<h;a++)o=u[a],(null==t||("function"==typeof t?t(o):void 0))&&r.oversized.push(o);for(l=0,c=(p=n.contents).length;l<c;l++)o=p[l],(null==t||("function"==typeof t?t(o):void 0))&&r.contents.push(o);return r.size+=r.oversized.length+r.contents.length,0===r.size?null:r})(this)},e.prototype.reject=function(e){return this.filter(function(t){return!("function"==typeof e?e(t):void 0)})},e.prototype.visit=function(e){var t,s,n;for(s=[this];s.length>0;){n=s.shift(),e.bind(n)();for(t in n.children)null!=n.children[t].tree&&s.push(n.children[t].tree)}return this},e.prototype.pretty=function(){var e,t,s,n,i,r,o;for(r="",s=function(e){var t,s,n;for(n="",t=s=e;s<=0?t<0:t>0;s<=0?++t:--t)n+="   ";return n},t=[{label:"ROOT",tree:this,level:0}];t.length>0;){r+=(n=s((o=t.shift()).level))+"| "+o.label+"\n"+n+"| ------------\n",o.tree.oversized.length>0&&(r+=n+"| * Oversized elements *\n"+n+"|   "+o.tree.oversized+"\n"),o.tree.contents.length>0&&(r+=n+"| * Leaf content *\n"+n+"|   "+o.tree.contents+"\n"),i=!1;for(e in o.tree.children)null!=o.tree.children[e].tree&&(i=!0,t.unshift({label:e,tree:o.tree.children[e].tree,level:o.level+1}));i&&(r+=n+"└──┐\n")}return r},e}()})},202:function(e,t,s){"use strict";const n=s(103);const i=s(43);const r=s(102);const o=s(18);const a=s(24);const l=s(99);const h=s(17);const c=s(104);class f extends n{constructor(e,t){super();e=Object.assign({maxPayload:100*1024*1024,perMessageDeflate:false,handleProtocols:null,clientTracking:true,verifyClient:null,noServer:false,backlog:null,server:null,host:null,path:null,port:null},e);if(e.port==null&&!e.server&&!e.noServer){throw new TypeError('One of the "port", "server", or "noServer" options must be specified')}if(e.port!=null){this._server=r.createServer((e,t)=>{const s=r.STATUS_CODES[426];t.writeHead(426,{"Content-Length":s.length,"Content-Type":"text/plain"});t.end(s)});this._server.listen(e.port,e.host,e.backlog,t)}else if(e.server){this._server=e.server}if(this._server){this._removeListeners=d(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(e,t,s)=>{this.handleUpgrade(e,t,s,t=>{this.emit("connection",t,e)})}})}if(e.perMessageDeflate===true)e.perMessageDeflate={};if(e.clientTracking)this.clients=new Set;this.options=e}address(){if(this.options.noServer){throw new Error('The server is operating in "noServer" mode')}if(!this._server)return null;return this._server.address()}close(e){if(this.clients){for(const e of this.clients)e.terminate()}const t=this._server;if(t){this._removeListeners();this._removeListeners=this._server=null;if(this.options.port!=null)return t.close(e)}if(e)e()}shouldHandle(e){if(this.options.path&&o.parse(e.url).pathname!==this.options.path){return false}return true}handleUpgrade(e,t,s,n){t.on("error",u);const i=+e.headers["sec-websocket-version"];const r={};if(e.method!=="GET"||e.headers.upgrade.toLowerCase()!=="websocket"||!e.headers["sec-websocket-key"]||i!==8&&i!==13||!this.shouldHandle(e)){return p(t,400)}if(this.options.perMessageDeflate){const s=new a(this.options.perMessageDeflate,true,this.options.maxPayload);try{const n=l.parse(e.headers["sec-websocket-extensions"]);if(n[a.extensionName]){s.accept(n[a.extensionName]);r[a.extensionName]=s}}catch(e){return p(t,400)}}if(this.options.verifyClient){const o={origin:e.headers[`${i===8?"sec-websocket-origin":"origin"}`],secure:!!(e.connection.authorized||e.connection.encrypted),req:e};if(this.options.verifyClient.length===2){this.options.verifyClient(o,(i,o,a,l)=>{if(!i){return p(t,o||401,a,l)}this.completeUpgrade(r,e,t,s,n)});return}if(!this.options.verifyClient(o))return p(t,401)}this.completeUpgrade(r,e,t,s,n)}completeUpgrade(e,t,s,n,r){if(!s.readable||!s.writable)return s.destroy();const o=i.createHash("sha1").update(t.headers["sec-websocket-key"]+h.GUID,"binary").digest("base64");const f=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${o}`];const d=new c(null);var p=t.headers["sec-websocket-protocol"];if(p){p=p.trim().split(/ *, */);if(this.options.handleProtocols){p=this.options.handleProtocols(p,t)}else{p=p[0]}if(p){f.push(`Sec-WebSocket-Protocol: ${p}`);d.protocol=p}}if(e[a.extensionName]){const t=e[a.extensionName].params;const s=l.format({[a.extensionName]:[t]});f.push(`Sec-WebSocket-Extensions: ${s}`);d._extensions=e}this.emit("headers",f,t);s.write(f.concat("\r\n").join("\r\n"));s.removeListener("error",u);d.setSocket(s,n,this.options.maxPayload);if(this.clients){this.clients.add(d);d.on("close",()=>this.clients.delete(d))}r(d)}}e.exports=f;function d(e,t){for(const s of Object.keys(t))e.on(s,t[s]);return function s(){for(const s of Object.keys(t)){e.removeListener(s,t[s])}}}function u(){this.destroy()}function p(e,t,s,n){if(e.writable){s=s||r.STATUS_CODES[t];n=Object.assign({Connection:"close","Content-type":"text/html","Content-Length":Buffer.byteLength(s)},n);e.write(`HTTP/1.1 ${t} ${r.STATUS_CODES[t]}\r\n`+Object.keys(n).map(e=>`${e}: ${n[e]}`).join("\r\n")+"\r\n\r\n"+s)}e.removeListener("error",u);e.destroy()}},203:function(e,t,s){"use strict";
/*!
 * UTF-8 validate: UTF-8 validation for WebSockets.
 * Copyright(c) 2015 Einar Otto Stangvik <einaros@gmail.com>
 * MIT Licensed
 */const n=e=>{var t=e.length;var s=0;while(s<t){if(e[s]<128){s++}else if((e[s]&224)===192){if(s+1===t||(e[s+1]&192)!==128||(e[s]&254)===192){return false}else{s+=2}}else if((e[s]&240)===224){if(s+2>=t||(e[s+1]&192)!==128||(e[s+2]&192)!==128||e[s]===224&&(e[s+1]&224)===128||e[s]===237&&(e[s+1]&224)===160){return false}else{s+=3}}else if((e[s]&248)===240){if(s+3>=t||(e[s+1]&192)!==128||(e[s+2]&192)!==128||(e[s+3]&192)!==128||e[s]===240&&(e[s+1]&240)===128||e[s]===244&&e[s+1]>143||e[s]>244){return false}else{s+=4}}else{return false}}return true};e.exports=n},204:function(e,t,s){"use strict";try{e.exports=s(101)("validation")}catch(t){e.exports=s(203)}},205:function(e,t){e.exports=require("stream")},206:function(e,t,s){"use strict";class n{constructor(e,t){this.target=t;this.type=e}}class i extends n{constructor(e,t){super("message",t);this.data=e}}class r extends n{constructor(e,t,s){super("close",s);this.wasClean=s._closeFrameReceived&&s._closeFrameSent;this.reason=t;this.code=e}}class o extends n{constructor(e){super("open",e)}}class a extends n{constructor(e,t){super("error",t);this.message=e.message;this.error=e}}const l={addEventListener(e,t){if(typeof t!=="function")return;function s(e){t.call(this,new i(e,this))}function n(e,s){t.call(this,new r(e,s,this))}function l(e){t.call(this,new a(e,this))}function h(){t.call(this,new o(this))}if(e==="message"){s._listener=t;this.on(e,s)}else if(e==="close"){n._listener=t;this.on(e,n)}else if(e==="error"){l._listener=t;this.on(e,l)}else if(e==="open"){h._listener=t;this.on(e,h)}else{this.on(e,t)}},removeEventListener(e,t){const s=this.listeners(e);for(var n=0;n<s.length;n++){if(s[n]===t||s[n]._listener===t){this.removeListener(e,s[n])}}}};e.exports=l},207:function(e,t,s){"use strict";
/*!
 * bufferutil: WebSocket buffer utils
 * Copyright(c) 2015 Einar Otto Stangvik <einaros@gmail.com>
 * MIT Licensed
 */const n=(e,t,s,n,i)=>{for(var r=0;r<i;r++){s[n+r]=e[r]^t[r&3]}};const i=(e,t)=>{const s=e.length;for(var n=0;n<s;n++){e[n]^=t[n&3]}};e.exports={mask:n,unmask:i}},208:function(e,t){e.exports=require("fs")},209:function(e,t,s){"use strict";try{e.exports=s(101)("bufferutil")}catch(t){e.exports=s(207)}},210:function(e,t){e.exports=require("zlib")},211:function(e,t,s){"use strict";function n(e){if(!(this instanceof n)){return new n(e)}e=e||{};this.concurrency=e.concurrency||Infinity;this.pending=0;this.jobs=[];this.cbs=[];this._done=r.bind(this)}var i=["push","unshift","splice"];i.forEach(function(e){n.prototype[e]=function(){var t=Array.prototype[e].apply(this.jobs,arguments);this._run();return t}});Object.defineProperty(n.prototype,"length",{get:function(){return this.pending+this.jobs.length}});n.prototype._run=function(){if(this.pending===this.concurrency){return}if(this.jobs.length){var e=this.jobs.shift();this.pending++;e(this._done);this._run()}if(this.pending===0){while(this.cbs.length!==0){var t=this.cbs.pop();process.nextTick(t)}}};n.prototype.onDone=function(e){if(typeof e==="function"){this.cbs.push(e);this._run()}};function r(){this.pending--;this._run()}e.exports=n},212:function(e,t){e.exports=require("tls")},213:function(e,t){e.exports=require("net")},214:function(e,t){e.exports=require("https")},215:function(e,t,s){"use strict";const n=s(104);n.Server=s(202);n.Receiver=s(98);n.Sender=s(96);e.exports=n},216:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:true});const n=s(19);class i extends n.Snake{constructor(e,t,s,n,i,r,o,a,l,h){super(e,t,s,n,i,r,o,a,l);this.ws=h;this.lastDirX=o;this.lastDirY=a}}t.NetworkSnake=i},217:function(e,t,s){"use strict";var n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s in e)if(Object.hasOwnProperty.call(e,s))t[s]=e[s];t["default"]=e;return t};Object.defineProperty(t,"__esModule",{value:true});const i=s(19);const r=s(216);const o=s(10);const a=n(s(215));let l=s(201);console.log("TS server launching ... "+o.SaclaySlitherGame.WORLDRADIUS);let h=new a.Server({port:9090});let c={};let f=new o.SaclaySlitherGame;let d=0;let u;let p;function m(){f=new o.SaclaySlitherGame;for(let e=0;e<o.SaclaySlitherGame.NBINITIALFOODS;e++){let e=i.Food.newFood(f);f.foods.push(e)}for(let e=0;e<o.SaclaySlitherGame.NBINITIALSNAKES;e++){f.snakes[e]=new i.Snake(f,f.names[e%f.names.length],Math.max(40,400+50*(e-1)),o.SaclaySlitherGame.WORLDRADIUS/2+Math.floor(900*Math.cos(e*2*Math.PI/o.SaclaySlitherGame.NBINITIALSNAKES)),o.SaclaySlitherGame.WORLDRADIUS/2+Math.floor(900*Math.sin(e*2*Math.PI/o.SaclaySlitherGame.NBINITIALSNAKES)),e%o.SaclaySlitherGame.colors.length,Math.floor(o.SaclaySlitherGame.SPACEBETWEENSEGMENTS*Math.cos(e*2*Math.PI/o.SaclaySlitherGame.NBINITIALSNAKES)),Math.floor(o.SaclaySlitherGame.SPACEBETWEENSEGMENTS*Math.sin(e*2*Math.PI/o.SaclaySlitherGame.NBINITIALSNAKES)),i.SnakeStrategy.GOBESTFOOD)}console.log("INI "+f.snakes[10].name+" "+f.snakes[10].pos[0].x.toFixed(2)+" "+f.snakes[10].pos[0].y.toFixed(2)+" "+f.snakes[10].pos[1].x.toFixed(2)+" "+f.snakes[10].pos[1].y.toFixed(2)+" "+f.snakes[10].pos[2].x.toFixed(2)+" "+f.snakes[10].pos[2].y.toFixed(2)+"..."+" "+f.snakes[10].pos[f.snakes[10].pos.length-1].x.toFixed(2)+" "+f.snakes[10].pos[f.snakes[10].pos.length-1].y.toFixed(2))}function S(){d++;console.log("AV "+f.snakes[10].name+" "+f.snakes[10].pos[0].x.toFixed(2)+","+f.snakes[10].pos[0].y.toFixed(2)+" "+f.snakes[10].pos[1].x.toFixed(2)+","+f.snakes[10].pos[1].y.toFixed(2)+" "+f.snakes[10].pos[2].x.toFixed(2)+","+f.snakes[10].pos[2].y.toFixed(2)+"..."+" "+f.snakes[10].pos[f.snakes[10].pos.length-1].x.toFixed(2)+" "+f.snakes[10].pos[f.snakes[10].pos.length-1].y.toFixed(2)+" ===> "+f.snakes[10].dirX.toFixed(2)+","+f.snakes[10].dirY.toFixed(2));p[d]=[];for(let e=0;e<f.snakes.length;e++){if(f.snakes[e]instanceof r.NetworkSnake){let t=f.snakes[e];t.lastDirX=f.snakes[e].dirX;t.lastDirY=f.snakes[e].dirY;t.moveSnake(t.dirX,t.dirY);if(t.ws.readyState==a.OPEN)t.ws.send("MOVE "+t.pos[0].x+" "+t.pos[0].y+" "+t.lastDirX+" "+t.lastDirY)}else if(f.snakes[e]){let t=f.snakes[e].dirX;let s=f.snakes[e].dirY;let n=f.snakes[e].pos[0].x;let r=f.snakes[e].pos[0].y;let a=Math.hypot(n,r);let l=(10+Math.random()*5)*t+(Math.random()*16-8)*s;let h=(10+Math.random()*5)*s-(Math.random()*16-8)*t;if(a>1e3){l+=-n*(a-1e3)/a;h+=-r*(a-1e3)/a}if(f.snakes[e].state==i.SnakeStrategy.AVOIDBORDER&&f.snakes[e].closestSnakeP!=null){let t=Math.hypot(n,r);let s=-n/t*20;let i=-r/t*20;let o=Math.atan2(i,s);f.snakes[e].moveSnake(n+20*Math.cos(o),r+20*Math.sin(o))}else if(f.snakes[e].state==i.SnakeStrategy.AVOIDCLOSEST&&f.snakes[e].closestSnakeP!=null){let t=f.snakes[e].closestSnakeP;let s=n-t.x;let i=r-t.y;let o=Math.atan2(i,s);f.snakes[e].moveSnake(n+20*Math.cos(o),r+20*Math.sin(o))}else if(f.snakes[e].state==i.SnakeStrategy.AVOIDWORST&&f.snakes[e].closestBadSnakeP!=null){let t=f.snakes[e].closestBadSnakeP;let s=n-t.x;let i=r-t.y;let o=Math.atan2(i,s);f.snakes[e].moveSnake(n+20*Math.cos(o),r+20*Math.sin(o))}else if(f.snakes[e].state==i.SnakeStrategy.GOBESTFOOD&&f.snakes[e].bestFood!=null){let t=f.snakes[e].bestFood;f.snakes[e].moveSnake(t.x,t.y)}else if(f.snakes[e].state==i.SnakeStrategy.GOCLOSESTFOOD&&f.snakes[e].closestFood!=null){let t=f.snakes[e].closestFood;f.snakes[e].moveSnake(t.x,t.y)}else if(f.snakes[e].state==i.SnakeStrategy.FASTSTRAIGHT){if(f.snakes[e].speed<o.SaclaySlitherGame.MAX_SPEED&&f.snakes[e].weight>40+o.SaclaySlitherGame.LOOSEWEIGHT)f.snakes[e].speed=o.SaclaySlitherGame.MAX_SPEED;f.snakes[e].moveSnake(n+t,r+s)}else if(f.snakes[e].state==i.SnakeStrategy.ROT){f.snakes[e].moveSnake(n+l,r+h)}else if(f.snakes[e].state==i.SnakeStrategy.RANDWALK){f.snakes[e].moveSnake(n+10*t-100*s,r+10*s+100*t)}else{f.snakes[e].moveSnake(n+t,r+s)}if(f.snakes[e].testCollision(p[d])){console.log(f.snakes[e].name+" is dead");for(let t=0;t<f.snakes[e].pos.length;t++){let s=f.snakes[e].pos[t];let n=new i.Food(s.x,s.y,0);n.rd=10;if(t%2==0)f.foods.push(n)}let t=Math.random()*2*Math.PI;let s=Math.random()*o.SaclaySlitherGame.WORLDRADIUS;f.snakes[e]=new i.Snake(f,f.names[e%f.names.length],40,Math.floor(s*Math.cos(t)),Math.floor(s*Math.sin(t)),e%o.SaclaySlitherGame.colors.length,10*Math.cos(e*Math.PI/3),10*Math.sin(e*Math.PI/3),i.SnakeStrategy.GOBESTFOOD)}if(f.snakes[e].state!=i.SnakeStrategy.AVOIDBORDER){let t=f.snakes[e].pos[0];let s=Math.hypot(t.x,t.y);if(s>o.SaclaySlitherGame.WORLDRADIUS-100)f.snakes[e].state=i.SnakeStrategy.AVOIDBORDER}else if(f.snakes[e].state==i.SnakeStrategy.AVOIDBORDER){let t=f.snakes[e].pos[0];let s=Math.hypot(t.x,t.y);if(s<o.SaclaySlitherGame.WORLDRADIUS-200)f.snakes[e].state=i.SnakeStrategy.GOBESTFOOD}else if(f.snakes[e].state==i.SnakeStrategy.AVOIDWORST&&f.snakes[e].closestBadSnakeP!=null){let t=f.snakes[e].closestBadSnakeP;let s=f.snakes[e].dclosestBadSnake;console.log(f.snakes[e].name+" would not be affraid anymore if sketch.dist to "+f.snakes[e].closestBadSnake.name+" ="+s+">400   p="+t.x+","+t.y);if(s>200){f.snakes[e].state=i.SnakeStrategy.GOBESTFOOD;console.log(f.snakes[e].name+" is not affraid anymore")}}else if(f.snakes[e].state==i.SnakeStrategy.AVOIDCLOSEST&&f.snakes[e].closestSnakeP!=null){let t=f.snakes[e].closestSnakeP;if(f.snakes[e].closestSnake==f.snakes[0])console.log(f.snakes[e].name+" is affraid of me point["+e+"]="+t.x+","+t.y);let s=Math.hypot(t.x-n,t.y-r);if(s>300)f.snakes[e].state=i.SnakeStrategy.GOBESTFOOD}else if(f.snakes[e].state==i.SnakeStrategy.AVOIDWORST&&f.snakes[e].closestBadSnakeP==null){f.snakes[e].state=i.SnakeStrategy.GOBESTFOOD;console.log(f.snakes[e].name+" is not affraid anymore")}else if(f.snakes[e].state==i.SnakeStrategy.GOBESTFOOD&&f.snakes[e].closestBadSnakeP!=null){let t=f.snakes[e].closestBadSnakeP;let s=f.snakes[e].dclosestBadSnake;if(s<100){console.log(f.snakes[e].name+" is now affraid of "+f.snakes[e].closestBadSnake.name+" because "+s+"<200  p="+t.x+","+t.y);f.snakes[e].state=i.SnakeStrategy.AVOIDWORST}}}}console.log("AP "+f.snakes[10].name+" "+f.snakes[10].pos[0].x.toFixed(2)+","+f.snakes[10].pos[0].y.toFixed(2)+" "+f.snakes[10].pos[1].x.toFixed(2)+","+f.snakes[10].pos[1].y.toFixed(2)+" "+f.snakes[10].pos[2].x.toFixed(2)+","+f.snakes[10].pos[2].y.toFixed(2)+"..."+" "+f.snakes[10].pos[f.snakes[10].pos.length-1].x.toFixed(2)+" "+f.snakes[10].pos[f.snakes[10].pos.length-1].y.toFixed(2)+" ===> "+f.snakes[10].dirX.toFixed(2)+","+f.snakes[10].dirY.toFixed(2))}h.on("connection",(e,t)=>{const s=t.connection.remoteAddress;console.log(new Date+" Connection accepted "+s);e.on("message",function(t,n){if(typeof t==="string"){if(t.startsWith("Hello, I am ")){let n=t.substring(12,t.indexOf(";"));let a=t.substring(t.indexOf(";")+1);if(Object.keys(c).length==0){console.log("initGame "+o.SaclaySlitherGame.WORLDRADIUS);m()}if(c[s]){f.snakes.splice(f.snakes.indexOf(c[s]),1);delete c[s];console.log(f.snakes.length+"+1 snake renewed: "+n);e.send("Hello back "+n+", I am the server: "+f.snakes.length+"+1 snake renewed")}else{console.log(f.snakes.length+"+1 snake: "+n);e.send("Hello back "+n+", I am the server: "+f.snakes.length+"+1 snake")}c[s]=new r.NetworkSnake(f,n,500,o.SaclaySlitherGame.WORLDRADIUS/2,o.SaclaySlitherGame.WORLDRADIUS/2,parseInt(a),10,0,i.SnakeStrategy.GOBESTFOOD,e);f.snakes.push(c[s])}else if(t.startsWith("pause")){if(u!=null){clearInterval(u);u=null;console.log("pause")}else console.log("CANT PAUSE NON RUNNING GAME")}else if(t.startsWith("play")){if(u!=null){console.log("CANT RUN A RUNNING GAME")}else{u=setInterval(S,20);console.log("play")}}else if(t.startsWith("reset")){if(u!=null)clearInterval(u);m();let t=c[s].type;let n=c[s].name;c[s]=new r.NetworkSnake(f,n,500,o.SaclaySlitherGame.WORLDRADIUS/2,o.SaclaySlitherGame.WORLDRADIUS/2,t,10,0,i.SnakeStrategy.GOBESTFOOD,e)}else if(t.startsWith("update")){S()}}else if(typeof t==="object"){let n=t;if(n.length==6*4){let t=new Float32Array(2+f.snakes.length*8);let i=n.readFloatLE(0);let r=n.readFloatLE(4);c[s].speed=n.readFloatLE(8);let o=n.readFloatLE(12);let a=n.readFloatLE(16);let l=n.readFloatLE(20);let h=0;let u=0;c[s].dirX=i;c[s].dirY=r;console.log("receive update from "+s+" = "+c[s].name);let p=c[s].pos[0].x;let m=c[s].pos[0].y;c[s].dirX=i;c[s].dirY=r;t[0]=d;t[1]=f.snakes.length;for(let e=0;e<f.snakes.length;e++){t[2+e*8+0]=f.snakes[e].dirX;t[2+e*8+1]=f.snakes[e].dirY;t[2+e*8+2]=f.snakes[e].pos[0].x;t[2+e*8+3]=f.snakes[e].pos[0].y;t[2+e*8+4]=f.snakes[e].pos[f.snakes[e].pos.length-1].x;t[2+e*8+5]=f.snakes[e].pos[f.snakes[e].pos.length-1].y;t[2+e*8+6]=f.snakes[e].speed;t[2+e*8+7]=f.snakes[e].weight}e.send(t)}else if(n.length==4*4){let t=0;for(let e=0;e<f.snakes.length;e++)t+=f.snakes[e].size;let s=new Float32Array(3+f.snakes.length*7+t*2+f.foods.length*3);let i=n.readFloatLE(0);let r=n.readFloatLE(4);let o=n.readFloatLE(8);let a=n.readFloatLE(12);s[0]=f.snakes.length;s[1]=f.foods.length;s[2]=t;let l=3;for(let e=0;e<f.snakes.length;e++){s[l+0]=f.snakes[e].size;s[l+1]=f.snakes[e].weight;s[l+2]=f.snakes[e].dirX;s[l+3]=f.snakes[e].dirY;s[l+4]=f.snakes[e].type;s[l+5]=f.snakes[e].pos[0].x;s[l+6]=f.snakes[e].pos[0].y;l+=7}for(let e=0;e<f.snakes.length;e++){for(let t=0;t<f.snakes[e].size;t++){s[l+0]=f.snakes[e].pos[t].x;s[l+1]=f.snakes[e].pos[t].y;l+=2}}for(let e=0;e<f.foods.length;e++){s[l+0]=f.foods[e].x;s[l+1]=f.foods[e].y;s[l+2]=f.foods[e].rd;l+=3}console.log("  sent "+l+"%"+s.length);console.log("=> "+f.snakes[10].name+" "+f.snakes[10].pos[0].x.toFixed(2)+" "+f.snakes[10].pos[0].y.toFixed(2)+" "+f.snakes[10].pos[1].x.toFixed(2)+" "+f.snakes[10].pos[1].y.toFixed(2)+" "+f.snakes[10].pos[2].x.toFixed(2)+" "+f.snakes[10].pos[2].y.toFixed(2));e.send(s)}}else{console.log("Unknown message type: "+n)}});h.on("close",function(e,t){console.log(new Date+" Peer "+h.address+" disconnected.")})})},24:function(e,t,s){"use strict";const n=s(211);const i=s(210);const r=s(42);const o=s(17);const a=Buffer.from([0,0,255,255]);const l=Buffer.from([0]);const h=Symbol("permessage-deflate");const c=Symbol("write-in-progress");const f=Symbol("pending-close");const d=Symbol("total-length");const u=Symbol("callback");const p=Symbol("buffers");const m=Symbol("error");let S;class _{constructor(e,t,s){this._maxPayload=s|0;this._options=e||{};this._threshold=this._options.threshold!==undefined?this._options.threshold:1024;this._isServer=!!t;this._deflate=null;this._inflate=null;this.params=null;if(!S){const e=this._options.concurrencyLimit!==undefined?this._options.concurrencyLimit:10;S=new n({concurrency:e})}}static get extensionName(){return"permessage-deflate"}offer(){const e={};if(this._options.serverNoContextTakeover){e.server_no_context_takeover=true}if(this._options.clientNoContextTakeover){e.client_no_context_takeover=true}if(this._options.serverMaxWindowBits){e.server_max_window_bits=this._options.serverMaxWindowBits}if(this._options.clientMaxWindowBits){e.client_max_window_bits=this._options.clientMaxWindowBits}else if(this._options.clientMaxWindowBits==null){e.client_max_window_bits=true}return e}accept(e){e=this.normalizeParams(e);this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e);return this.params}cleanup(){if(this._inflate){if(this._inflate[c]){this._inflate[f]=true}else{this._inflate.close();this._inflate=null}}if(this._deflate){if(this._deflate[c]){this._deflate[f]=true}else{this._deflate.close();this._deflate=null}}}acceptAsServer(e){const t=this._options;const s=e.find(e=>{if(t.serverNoContextTakeover===false&&e.server_no_context_takeover||e.server_max_window_bits&&(t.serverMaxWindowBits===false||typeof t.serverMaxWindowBits==="number"&&t.serverMaxWindowBits>e.server_max_window_bits)||typeof t.clientMaxWindowBits==="number"&&!e.client_max_window_bits){return false}return true});if(!s){throw new Error("None of the extension offers can be accepted")}if(t.serverNoContextTakeover){s.server_no_context_takeover=true}if(t.clientNoContextTakeover){s.client_no_context_takeover=true}if(typeof t.serverMaxWindowBits==="number"){s.server_max_window_bits=t.serverMaxWindowBits}if(typeof t.clientMaxWindowBits==="number"){s.client_max_window_bits=t.clientMaxWindowBits}else if(s.client_max_window_bits===true||t.clientMaxWindowBits===false){delete s.client_max_window_bits}return s}acceptAsClient(e){const t=e[0];if(this._options.clientNoContextTakeover===false&&t.client_no_context_takeover){throw new Error('Unexpected parameter "client_no_context_takeover"')}if(!t.client_max_window_bits){if(typeof this._options.clientMaxWindowBits==="number"){t.client_max_window_bits=this._options.clientMaxWindowBits}}else if(this._options.clientMaxWindowBits===false||typeof this._options.clientMaxWindowBits==="number"&&t.client_max_window_bits>this._options.clientMaxWindowBits){throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}return t}normalizeParams(e){e.forEach(e=>{Object.keys(e).forEach(t=>{var s=e[t];if(s.length>1){throw new Error(`Parameter "${t}" must have only a single value`)}s=s[0];if(t==="client_max_window_bits"){if(s!==true){const e=+s;if(!Number.isInteger(e)||e<8||e>15){throw new TypeError(`Invalid value for parameter "${t}": ${s}`)}s=e}else if(!this._isServer){throw new TypeError(`Invalid value for parameter "${t}": ${s}`)}}else if(t==="server_max_window_bits"){const e=+s;if(!Number.isInteger(e)||e<8||e>15){throw new TypeError(`Invalid value for parameter "${t}": ${s}`)}s=e}else if(t==="client_no_context_takeover"||t==="server_no_context_takeover"){if(s!==true){throw new TypeError(`Invalid value for parameter "${t}": ${s}`)}}else{throw new Error(`Unknown parameter "${t}"`)}e[t]=s})});return e}decompress(e,t,s){S.push(n=>{this._decompress(e,t,(e,t)=>{n();s(e,t)})})}compress(e,t,s){S.push(n=>{this._compress(e,t,(e,t)=>{n();s(e,t)})})}_decompress(e,t,s){const n=this._isServer?"client":"server";if(!this._inflate){const e=`${n}_max_window_bits`;const t=typeof this.params[e]!=="number"?i.Z_DEFAULT_WINDOWBITS:this.params[e];this._inflate=i.createInflateRaw(Object.assign({},this._options.zlibInflateOptions,{windowBits:t}));this._inflate[h]=this;this._inflate[d]=0;this._inflate[p]=[];this._inflate.on("error",k);this._inflate.on("data",g)}this._inflate[u]=s;this._inflate[c]=true;this._inflate.write(e);if(t)this._inflate.write(a);this._inflate.flush(()=>{const e=this._inflate[m];if(e){this._inflate.close();this._inflate=null;s(e);return}const i=r.concat(this._inflate[p],this._inflate[d]);if(t&&this.params[`${n}_no_context_takeover`]||this._inflate[f]){this._inflate.close();this._inflate=null}else{this._inflate[c]=false;this._inflate[d]=0;this._inflate[p]=[]}s(null,i)})}_compress(e,t,s){if(!e||e.length===0){process.nextTick(s,null,l);return}const n=this._isServer?"server":"client";if(!this._deflate){const e=`${n}_max_window_bits`;const t=typeof this.params[e]!=="number"?i.Z_DEFAULT_WINDOWBITS:this.params[e];this._deflate=i.createDeflateRaw(Object.assign({memLevel:this._options.memLevel,level:this._options.level},this._options.zlibDeflateOptions,{windowBits:t}));this._deflate[d]=0;this._deflate[p]=[];this._deflate.on("data",y)}this._deflate[c]=true;this._deflate.write(e);this._deflate.flush(i.Z_SYNC_FLUSH,()=>{var e=r.concat(this._deflate[p],this._deflate[d]);if(t)e=e.slice(0,e.length-4);if(t&&this.params[`${n}_no_context_takeover`]||this._deflate[f]){this._deflate.close();this._deflate=null}else{this._deflate[c]=false;this._deflate[d]=0;this._deflate[p]=[]}s(null,e)})}}e.exports=_;function y(e){this[p].push(e);this[d]+=e.length}function g(e){this[d]+=e.length;if(this[h]._maxPayload<1||this[d]<=this[h]._maxPayload){this[p].push(e);return}this[m]=new RangeError("Max payload size exceeded");this[m][o.kStatusCode]=1009;this.removeListener("data",g);this.reset()}function k(e){this[h]._inflate=null;e[o.kStatusCode]=1007;this[u](e)}},25:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:true});function n(e,t,s,n){let i=s-e;let r=n-t;return Math.sqrt(i*i+r*r)}t.dist=n;function i(e){let t={};t.code=e;t.isDown=false;t.isUp=true;t.press=undefined;t.release=undefined;t.downHandler=(e=>{if(e.keyCode===t.code){if(t.isUp&&t.press)t.press();t.isDown=true;t.isUp=false}else console.log("unknown = "+e.keyCode);e.preventDefault()});t.upHandler=(e=>{if(e.keyCode===t.code){if(t.isDown&&t.release)t.release();t.isDown=false;t.isUp=true}e.preventDefault()});window.addEventListener("keydown",t.downHandler.bind(t),false);window.addEventListener("keyup",t.upHandler.bind(t),false);return t}t.keyboard=i},42:function(e,t,s){"use strict";function n(e,t){const s=Buffer.allocUnsafe(t);var n=0;for(var i=0;i<e.length;i++){const t=e[i];t.copy(s,n);n+=t.length}return s}function i(e,t,s,n,i){for(var r=0;r<i;r++){s[n+r]=e[r]^t[r&3]}}function r(e,t){const s=e.length;for(var n=0;n<s;n++){e[n]^=t[n&3]}}try{const t=s(209);const o=t.BufferUtil||t;e.exports={mask(e,t,s,n,r){if(r<48)i(e,t,s,n,r);else o.mask(e,t,s,n,r)},unmask(e,t){if(e.length<32)r(e,t);else o.unmask(e,t)},concat:n}}catch(t){e.exports={concat:n,mask:i,unmask:r}}},43:function(e,t){e.exports=require("crypto")},6:function(e,t){e.exports=require("path")},96:function(e,t,s){"use strict";const n=s(43);const i=s(24);const r=s(42);const o=s(97);const a=s(17);class l{constructor(e,t){this._extensions=t||{};this._socket=e;this._firstFragment=true;this._compress=false;this._bufferedBytes=0;this._deflating=false;this._queue=[]}static frame(e,t){const s=e.length<1024||t.mask&&t.readOnly;var i=t.mask?6:2;var o=e.length;if(e.length>=65536){i+=8;o=127}else if(e.length>125){i+=2;o=126}const a=Buffer.allocUnsafe(s?e.length+i:i);a[0]=t.fin?t.opcode|128:t.opcode;if(t.rsv1)a[0]|=64;if(o===126){a.writeUInt16BE(e.length,2)}else if(o===127){a.writeUInt32BE(0,2);a.writeUInt32BE(e.length,6)}if(!t.mask){a[1]=o;if(s){e.copy(a,i);return[a]}return[a,e]}const l=n.randomBytes(4);a[1]=o|128;a[i-4]=l[0];a[i-3]=l[1];a[i-2]=l[2];a[i-1]=l[3];if(s){r.mask(e,l,a,i,e.length);return[a]}r.mask(e,l,e,0,e.length);return[a,e]}close(e,t,s,n){var i;if(e===undefined){i=a.EMPTY_BUFFER}else if(typeof e!=="number"||!o.isValidStatusCode(e)){throw new TypeError("First argument must be a valid error code number")}else if(t===undefined||t===""){i=Buffer.allocUnsafe(2);i.writeUInt16BE(e,0)}else{i=Buffer.allocUnsafe(2+Buffer.byteLength(t));i.writeUInt16BE(e,0);i.write(t,2)}if(this._deflating){this.enqueue([this.doClose,i,s,n])}else{this.doClose(i,s,n)}}doClose(e,t,s){this.sendFrame(l.frame(e,{fin:true,rsv1:false,opcode:8,mask:t,readOnly:false}),s)}ping(e,t,s){var n=true;if(!Buffer.isBuffer(e)){if(e instanceof ArrayBuffer){e=Buffer.from(e)}else if(ArrayBuffer.isView(e)){e=h(e)}else{e=Buffer.from(e);n=false}}if(this._deflating){this.enqueue([this.doPing,e,t,n,s])}else{this.doPing(e,t,n,s)}}doPing(e,t,s,n){this.sendFrame(l.frame(e,{fin:true,rsv1:false,opcode:9,mask:t,readOnly:s}),n)}pong(e,t,s){var n=true;if(!Buffer.isBuffer(e)){if(e instanceof ArrayBuffer){e=Buffer.from(e)}else if(ArrayBuffer.isView(e)){e=h(e)}else{e=Buffer.from(e);n=false}}if(this._deflating){this.enqueue([this.doPong,e,t,n,s])}else{this.doPong(e,t,n,s)}}doPong(e,t,s,n){this.sendFrame(l.frame(e,{fin:true,rsv1:false,opcode:10,mask:t,readOnly:s}),n)}send(e,t,s){var n=t.binary?2:1;var r=t.compress;var o=true;if(!Buffer.isBuffer(e)){if(e instanceof ArrayBuffer){e=Buffer.from(e)}else if(ArrayBuffer.isView(e)){e=h(e)}else{e=Buffer.from(e);o=false}}const a=this._extensions[i.extensionName];if(this._firstFragment){this._firstFragment=false;if(r&&a){r=e.length>=a._threshold}this._compress=r}else{r=false;n=0}if(t.fin)this._firstFragment=true;if(a){const i={fin:t.fin,rsv1:r,opcode:n,mask:t.mask,readOnly:o};if(this._deflating){this.enqueue([this.dispatch,e,this._compress,i,s])}else{this.dispatch(e,this._compress,i,s)}}else{this.sendFrame(l.frame(e,{fin:t.fin,rsv1:false,opcode:n,mask:t.mask,readOnly:o}),s)}}dispatch(e,t,s,n){if(!t){this.sendFrame(l.frame(e,s),n);return}const r=this._extensions[i.extensionName];this._deflating=true;r.compress(e,s.fin,(e,t)=>{s.readOnly=false;this.sendFrame(l.frame(t,s),n);this._deflating=false;this.dequeue()})}dequeue(){while(!this._deflating&&this._queue.length){const e=this._queue.shift();this._bufferedBytes-=e[1].length;e[0].apply(this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[1].length;this._queue.push(e)}sendFrame(e,t){if(e.length===2){this._socket.write(e[0]);this._socket.write(e[1],t)}else{this._socket.write(e[0],t)}}}e.exports=l;function h(e){const t=Buffer.from(e.buffer);if(e.byteLength!==e.buffer.byteLength){return t.slice(e.byteOffset,e.byteOffset+e.byteLength)}return t}},97:function(e,t,s){"use strict";try{const e=s(204);t.isValidUTF8=typeof e==="object"?e.Validation.isValidUTF8:e}catch(e){t.isValidUTF8=(()=>true)}t.isValidStatusCode=(e=>{return e>=1e3&&e<=1013&&e!==1004&&e!==1005&&e!==1006||e>=3e3&&e<=4999})},98:function(e,t,s){"use strict";const n=s(205);const i=s(24);const r=s(42);const o=s(97);const a=s(17);const l=0;const h=1;const c=2;const f=3;const d=4;const u=5;class p extends n.Writable{constructor(e,t,s){super();this._binaryType=e||a.BINARY_TYPES[0];this[a.kWebSocket]=undefined;this._extensions=t||{};this._maxPayload=s|0;this._bufferedBytes=0;this._buffers=[];this._compressed=false;this._payloadLength=0;this._mask=undefined;this._fragmented=0;this._masked=false;this._fin=false;this._opcode=0;this._totalPayloadLength=0;this._messageLength=0;this._fragments=[];this._state=l;this._loop=false}_write(e,t,s){if(this._opcode===8)return s();this._bufferedBytes+=e.length;this._buffers.push(e);this.startLoop(s)}consume(e){this._bufferedBytes-=e;if(e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){const t=this._buffers[0];this._buffers[0]=t.slice(e);return t.slice(0,e)}const t=Buffer.allocUnsafe(e);do{const s=this._buffers[0];if(e>=s.length){this._buffers.shift().copy(t,t.length-e)}else{s.copy(t,t.length-e,0,e);this._buffers[0]=s.slice(e)}e-=s.length}while(e>0);return t}startLoop(e){var t;this._loop=true;do{switch(this._state){case l:t=this.getInfo();break;case h:t=this.getPayloadLength16();break;case c:t=this.getPayloadLength64();break;case f:this.getMask();break;case d:t=this.getData(e);break;default:this._loop=false;return}}while(this._loop);e(t)}getInfo(){if(this._bufferedBytes<2){this._loop=false;return}const e=this.consume(2);if((e[0]&48)!==0){this._loop=false;return m(RangeError,"RSV2 and RSV3 must be clear",true,1002)}const t=(e[0]&64)===64;if(t&&!this._extensions[i.extensionName]){this._loop=false;return m(RangeError,"RSV1 must be clear",true,1002)}this._fin=(e[0]&128)===128;this._opcode=e[0]&15;this._payloadLength=e[1]&127;if(this._opcode===0){if(t){this._loop=false;return m(RangeError,"RSV1 must be clear",true,1002)}if(!this._fragmented){this._loop=false;return m(RangeError,"invalid opcode 0",true,1002)}this._opcode=this._fragmented}else if(this._opcode===1||this._opcode===2){if(this._fragmented){this._loop=false;return m(RangeError,`invalid opcode ${this._opcode}`,true,1002)}this._compressed=t}else if(this._opcode>7&&this._opcode<11){if(!this._fin){this._loop=false;return m(RangeError,"FIN must be set",true,1002)}if(t){this._loop=false;return m(RangeError,"RSV1 must be clear",true,1002)}if(this._payloadLength>125){this._loop=false;return m(RangeError,`invalid payload length ${this._payloadLength}`,true,1002)}}else{this._loop=false;return m(RangeError,`invalid opcode ${this._opcode}`,true,1002)}if(!this._fin&&!this._fragmented)this._fragmented=this._opcode;this._masked=(e[1]&128)===128;if(this._payloadLength===126)this._state=h;else if(this._payloadLength===127)this._state=c;else return this.haveLength()}getPayloadLength16(){if(this._bufferedBytes<2){this._loop=false;return}this._payloadLength=this.consume(2).readUInt16BE(0);return this.haveLength()}getPayloadLength64(){if(this._bufferedBytes<8){this._loop=false;return}const e=this.consume(8);const t=e.readUInt32BE(0);if(t>Math.pow(2,53-32)-1){this._loop=false;return m(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",false,1009)}this._payloadLength=t*Math.pow(2,32)+e.readUInt32BE(4);return this.haveLength()}haveLength(){if(this._payloadLength&&this._opcode<8){this._totalPayloadLength+=this._payloadLength;if(this._totalPayloadLength>this._maxPayload&&this._maxPayload>0){this._loop=false;return m(RangeError,"Max payload size exceeded",false,1009)}}if(this._masked)this._state=f;else this._state=d}getMask(){if(this._bufferedBytes<4){this._loop=false;return}this._mask=this.consume(4);this._state=d}getData(e){var t=a.EMPTY_BUFFER;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=false;return}t=this.consume(this._payloadLength);if(this._masked)r.unmask(t,this._mask)}if(this._opcode>7)return this.controlMessage(t);if(this._compressed){this._state=u;this.decompress(t,e);return}if(t.length){this._messageLength=this._totalPayloadLength;this._fragments.push(t)}return this.dataMessage()}decompress(e,t){const s=this._extensions[i.extensionName];s.decompress(e,this._fin,(e,s)=>{if(e)return t(e);if(s.length){this._messageLength+=s.length;if(this._messageLength>this._maxPayload&&this._maxPayload>0){return t(m(RangeError,"Max payload size exceeded",false,1009))}this._fragments.push(s)}const n=this.dataMessage();if(n)return t(n);this.startLoop(t)})}dataMessage(){if(this._fin){const t=this._messageLength;const s=this._fragments;this._totalPayloadLength=0;this._messageLength=0;this._fragmented=0;this._fragments=[];if(this._opcode===2){var e;if(this._binaryType==="nodebuffer"){e=S(s,t)}else if(this._binaryType==="arraybuffer"){e=_(S(s,t))}else{e=s}this.emit("message",e)}else{const e=S(s,t);if(!o.isValidUTF8(e)){this._loop=false;return m(Error,"invalid UTF-8 sequence",true,1007)}this.emit("message",e.toString())}}this._state=l}controlMessage(e){if(this._opcode===8){this._loop=false;if(e.length===0){this.emit("conclude",1005,"");this.end()}else if(e.length===1){return m(RangeError,"invalid payload length 1",true,1002)}else{const t=e.readUInt16BE(0);if(!o.isValidStatusCode(t)){return m(RangeError,`invalid status code ${t}`,true,1002)}const s=e.slice(2);if(!o.isValidUTF8(s)){return m(Error,"invalid UTF-8 sequence",true,1007)}this.emit("conclude",t,s.toString());this.end()}return}if(this._opcode===9)this.emit("ping",e);else this.emit("pong",e);this._state=l}}e.exports=p;function m(e,t,s,n){const i=new e(s?`Invalid WebSocket frame: ${t}`:t);Error.captureStackTrace(i,m);i[a.kStatusCode]=n;return i}function S(e,t){if(e.length===1)return e[0];if(e.length>1)return r.concat(e,t);return a.EMPTY_BUFFER}function _(e){if(e.byteOffset===0&&e.byteLength===e.buffer.byteLength){return e.buffer}return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}},99:function(e,t,s){"use strict";const n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function i(e,t,s){if(Object.prototype.hasOwnProperty.call(e,t))e[t].push(s);else e[t]=[s]}function r(e){const t={};if(e===undefined||e==="")return t;var s={};var r=false;var o=false;var a=false;var l;var h;var c=-1;var f=-1;for(var d=0;d<e.length;d++){const p=e.charCodeAt(d);if(l===undefined){if(f===-1&&n[p]===1){if(c===-1)c=d}else if(p===32||p===9){if(f===-1&&c!==-1)f=d}else if(p===59||p===44){if(c===-1){throw new SyntaxError(`Unexpected character at index ${d}`)}if(f===-1)f=d;const n=e.slice(c,f);if(p===44){i(t,n,s);s={}}else{l=n}c=f=-1}else{throw new SyntaxError(`Unexpected character at index ${d}`)}}else if(h===undefined){if(f===-1&&n[p]===1){if(c===-1)c=d}else if(p===32||p===9){if(f===-1&&c!==-1)f=d}else if(p===59||p===44){if(c===-1){throw new SyntaxError(`Unexpected character at index ${d}`)}if(f===-1)f=d;i(s,e.slice(c,f),true);if(p===44){i(t,l,s);s={};l=undefined}c=f=-1}else if(p===61&&c!==-1&&f===-1){h=e.slice(c,d);c=f=-1}else{throw new SyntaxError(`Unexpected character at index ${d}`)}}else{if(o){if(n[p]!==1){throw new SyntaxError(`Unexpected character at index ${d}`)}if(c===-1)c=d;else if(!r)r=true;o=false}else if(a){if(n[p]===1){if(c===-1)c=d}else if(p===34&&c!==-1){a=false;f=d}else if(p===92){o=true}else{throw new SyntaxError(`Unexpected character at index ${d}`)}}else if(p===34&&e.charCodeAt(d-1)===61){a=true}else if(f===-1&&n[p]===1){if(c===-1)c=d}else if(c!==-1&&(p===32||p===9)){if(f===-1)f=d}else if(p===59||p===44){if(c===-1){throw new SyntaxError(`Unexpected character at index ${d}`)}if(f===-1)f=d;var u=e.slice(c,f);if(r){u=u.replace(/\\/g,"");r=false}i(s,h,u);if(p===44){i(t,l,s);s={};l=undefined}h=undefined;c=f=-1}else{throw new SyntaxError(`Unexpected character at index ${d}`)}}}if(c===-1||a){throw new SyntaxError("Unexpected end of input")}if(f===-1)f=d;const p=e.slice(c,f);if(l===undefined){i(t,p,{})}else{if(h===undefined){i(s,p,true)}else if(r){i(s,h,p.replace(/\\/g,""))}else{i(s,h,p)}i(t,l,s)}return t}function o(e){return Object.keys(e).map(t=>{var s=e[t];if(!Array.isArray(s))s=[s];return s.map(e=>{return[t].concat(Object.keys(e).map(t=>{var s=e[t];if(!Array.isArray(s))s=[s];return s.map(e=>e===true?t:`${t}=${e}`).join("; ")})).join("; ")}).join(", ")}).join(", ")}e.exports={format:o,parse:r}}});
//# sourceMappingURL=server.js.map